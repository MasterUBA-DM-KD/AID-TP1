---
title: "Trabajo Práctico 1"
author: "Alejandro Uribe"
date: "14/05/2023"
lang: en
description: |
  Asignatura: Análisis inteligente de datos
output:
  html_document:
    page-layout: full
    df_print: paged
    code-fold: show
    code-line-numbers: false
    code-tools: true
    code-overflow: scroll
    theme: cerulean
    highlight: pygments
    tidy: true
    toc: true
    toc_float: 
      collapsed: true
      smooth_scroll: true
    toc-location: left
    css: doc.css
    grid: 
      body-width: 2000px
      sidebar-width: 200px
      margin-width: 200px
website:
  sidebar:
      style: docked
      search: false
execute:
  echo: false
  warning: false
  freeze: auto
---

# Data

The data is related to direct marketing campaigns of a financial institution.The marketing campaigns were based on phone calls. Often, more than one contact to the same client was required, in order to assess if the product (bank term deposit) would be `yes` or not `no` subscribed. You will have to analyze the dataset in order to find ways to look for future strategies in order to improve future marketing campaigns for the bank.

## Attribute Information

### Input Variables

| \#  | Variable  | Type        | Description            | Examples                                                                                                                                                    |
|-------------|-------------|-------------|----------------------|-------------|
| 1   | age       | numeric     |                        |                                                                                                                                                             |
| 2   | job       | categorical | type of job            | `admin`, `blue-collar`, `entrepreneur`, `housemaid`, `management`, `retired`, `self-employed`, `services`, `student`, `technician`, `unemployed`, `unknown` |
| 3   | marital   | categorical | marital status         | `divorced`\*, `married`, `single`, `unknown`                                                                                                                |
| 4   | education | categorical |                        | `basic.4y`, `basic.6y`, `basic.9y`, `high.school`, `illiterate`, `professional.course`, `university.degree`, `unknown`                                      |
| 5   | default   | categorical | has credit in default? | `no`, `yes`, `unknown`                                                                                                                                      |
| 6   | balance   | numeric     |                        |                                                                                                                                                             |
| 7   | housing   | categorical | has housing loan?      | `no`, `yes`, `unknown`                                                                                                                                      |
| 8   | loan      | categorical | has personal loan?     | `no`, `yes`, `unknown`                                                                                                                                      |

> \* **Note:** `divorced` means `divorced` or `widowed`

*Related with the last contact of the current campaign*

| \#  | Variable | Type        | Description                         | Examples                                |
|-----------|-----------|-----------|----------------------------|-----------|
| 9   | contact  | categorical | contact communication type          | `cellular`, `telephone`                 |
| 10  | month    | categorical | last contact month of year          | `jan`, `feb`, `mar`, ... , `nov`, `dec` |
| 11  | day      | categorical | last contact day of the week        | `mon`, `tue`, `wed`, `thu`, `fri`       |
| 12  | duration | numeric     | last contact duration, in seconds\* |                                         |

> \* **Note:** This attribute highly affects the output `target` (e.g., if `duration=0` then `y=no`). Yet, the duration is not known before a call is performed. Also, after the end of the call y is obviously known. Thus, this input should only be included for benchmark purposes and should be discarded if the intention is to have a realistic predictive model.

*Other attributes*

| \#  | Variable | Type        | Description                                                                                | Examples                                        |
|--------|--------|--------|----------------------------------------|--------|
| 13  | campaign | numeric     | number of contacts performed during this campaign and for this client                      | Includes last contact                           |
| 14  | pdays    | numeric     | number of days that passed by after the client was last contacted from a previous campaign | `999` means client was not previously contacted |
| 15  | previous | numeric     | number of contacts performed before this campaign and for this client                      |                                                 |
| 16  | poutcome | categorical | outcome of the previous marketing campaign                                                 | `failure`, `nonexistent`, `success`             |

### Output variable

| \#  | Variable | Type   | Description                               | Examples    |
|-----------|-----------|-----------|------------------------------|-----------|
| 17  | deposit  | binary | has the client subscribed a term deposit? | `yes`, `no` |

# Librerías

```{r, echo=TRUE, include=TRUE, results='hide', message=FALSE}
library(splitstackshape)
library(ggplot2)
library(magrittr)
library(moments)
library(dplyr)
library(patchwork)
library(ggbeeswarm)
```

```{r set-options, echo=FALSE, cache=FALSE, include=FALSE, results='hide'}
options(width = 10000)
options(digits = 4)
options(nsmall=0)
```

```{r setup, echo=FALSE, include=FALSE, results='hide'}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

# Constantes

Se requiere fijar ciertas constantes, como el nivel de significancia, entre otros.

```{r}
alpha <- 0.05
```

# Datos

Se cargan los datos.

```{r}
df <- read.csv("data/training_data.csv")
```

Se muestran algunas filas de los datos.

```{r}
head(df)
```

Se buscó cuantificar la cantidad de valores nulos en cada columna.

```{r}
sapply(df, function(x) {
  length(which(is.na(x)))
})
```

Se concluyó que no hay nulos en los datos.

La variabe `duration` se escaló de segundos a minutos, a fin de mejorar el entendimiento de dicha variable.

```{r}
df$duration <- df$duration / 60
```


------------------------------------------------------------------------

# Consignas

## 1. Muestra

Para la base de datos seleccionada genere una muestra aleatoria estratificada y balanceada por "depósito" de tamaño `n = 2000` utilizando como semilla los últimos tres dígitos del DNI/PASAPORTE. Guarde los datos en un archivo y realice todo el trabajo práctico con la muestra generada.

A fin de generar una muestra estratificada de tamaño `n = 2000`, se fijó el valor `n_deposit = 1000` donde cada uno de los depósitos tendrá ese número de elementos.

```{r}
n_deposit <- 1000
target <- "deposit"
```

Se toma la muestra estraficada.

```{r}
set.seed(108)
df <- stratified(df, target, size=n_deposit)
```

Se muestra algunas filas de la muestra.

```{r}
head(df)
```

Se corroboró que los datos de la muestra estuviesen balanceados.

```{r}
table(df$deposit)
```

------------------------------------------------------------------------

## 2. Análisis estadístico

Realice un análisis estadístico de cada una de las variables numéricas para cada valor de depósito. Presente la información en forma tabular y conteniendo las siguientes medidas descriptivas:

-   Cantidad de datos
-   Mínimo, máximo
-   Media, mediana, moda
-   Varianza, desviación estándar
-   Coeficiente de variación
-   Cuartil 1, cuartil 3
-   Rango intercuartílico
-   MAD
-   Asimetría
-   Curtosis

Se listan las variables numéricas.

```{r}
numeric_cols <-
  c("age", "balance", "campaign", "duration", "pdays", "previous")
```

Se listan las variables categóricas.

```{r}
categorical_cols <-
  c(
    "contact",
    "day",
    "default",
    "education",
    "housing",
    "job",
    "loan",
    "marital",
    "month",
    "poutcome"
  )
```

Se creó un subset de los datos con únicamente las variables numéricas.

```{r}
df_numeric <- subset(df, select = numeric_cols)
```

A continuación se muestran ejemplos del subset de datos.

```{r}
head(df_numeric)
```

Se crearon dos funciones:

-   Obtener la moda
-   Calcular los estadísticos faltantes:
    -   Moda
    -   Varianza, Desviación estándar
    -   Coeficiente de variación
    -   Rango intercuartílico
    -   MAD
    -   Asimetría
    -   Curtosis
    -   Cantidad de datos

```{r}
getmode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}

multiple.func <- function(x) {
  c(
    MAD = mad(x),
    Mode = getmode(x),
    Var = var(x),
    SD = sd(x),
    CV = sd(x) / mean(x),
    IQR = IQR(x),
    Skewness = skewness(x),
    Kurtosis = kurtosis(x),
    Count = length(x)
  )
}
```

Se procedió a calcular los estadísticos de las columnas numéricas.

```{r}
numeric_summary <-
  data.frame(unclass(do.call(cbind, lapply(df_numeric, summary))),
             check.names = FALSE,
             stringsAsFactors = FALSE)
other_stats <- data.frame(lapply(df_numeric, multiple.func))
numeric_summary <- rbind(numeric_summary, other_stats)
```

Se muestran a continuación los estadísticos.

```{r}
numeric_summary
```

------------------------------------------------------------------------

## 3. Análisis gráfico

Represente gráficamente cada variable numérica eligiendo el gráfico que considere apropiado. Considere la posibilidad de generar rangos de datos para su análisis y representación gráfica de las variables.

#### `Age`

```{r cache=TRUE}
p <-
  ggplot(df,
         aes_string(y = numeric_cols[1], x = target, fill = target)) +
  geom_boxplot(
    alpha = 0.5,
    outlier.colour = "red",
    outlier.shape = 8,
    outlier.size = 2
  )

p1 <-
  ggplot(df,
         aes_string(x = numeric_cols[1], color = target, fill = target)) +
  geom_histogram(alpha = 0.5)

(p + guides(colour = "none" , fill = "none")) + p1 + plot_layout(ncol = 2) &
  theme_classic() + theme(legend.position = "bottom", legend.justification = "right")
```
> En el diagrama de caja se diferencian los outliers en color rojo y forma de estrella. No obstante, los mismos pueden no tener mucho sentido ya que la edad es una característica intrínseca y natural que no se considera atípica en sí misma. Cabe destacar que no se encontraron observaciones por debajo de los 18 años.

En el caso de `age` se definieron los siguientes rangos de edades:

* Adulto Joven: 18 ≤ `age` < 40
* Adulto Mediana edad: 40 ≤ `age` < 59
* Adulto Mayor: `age` ≥ 59

Se creó la variable `age_category`

```{r}
df$age_category <- cut(
  df$age,
  breaks = c(18, 40, 59, Inf),
  labels = c("Adulto Joven", "Adulto Mediana edad", "Adulto Mayor"),
  right = FALSE
)
```

Se generó una tabla de frecuencias con las nuevas categorías.

```{r}
association_table <- data.frame(table(df$deposit, df$age_category))
names(association_table) <- c(target, "age_category", "Frequency")
association_table
```

```{r cache=TRUE}
p <-
  ggplot(association_table,
         aes_string(x = "age_category", y = "Frequency", fill = target)) +
  geom_col(position="dodge") +
  geom_text(
    aes_string(label = "Frequency"),
    size = 3,
    hjust = 0.5,
    vjust = 1,
    position = position_dodge(width = .9)
  ) +
  xlab("Age Category")

p + theme_classic() + theme(legend.position = "bottom", legend.justification = "right")
```
> En los rangos de edades `Adulto Joven` y `Aldulto Mediana edad` los datos se encontraron cercanos a estar balanceados, mientras en el rango `Adulto Mayor` se encontró lo contrario.

#### `Balance`

```{r}
p <-
  ggplot(df,
         aes_string(y = numeric_cols[2], x = target, fill = target)) +
  geom_boxplot(alpha = 0.5, outlier.colour="red", outlier.shape=8,
                outlier.size=2)
p1 <-
  ggplot(df,
         aes_string(x = numeric_cols[2], color = target, fill = target)) +
  geom_density(alpha = 0.5)

(p + guides(colour = "none" , fill = "none")) + p1 + plot_layout(ncol = 2) &
  theme_classic() + theme(legend.position = "bottom", legend.justification = "right")
```
> De la variable en cuestión no se cuenta con información como el tipo de moneda. No obstante, la variable `balance` da cuenta de los fondos que los individuos tienen en su caja de ahorro. Se encontró que los datos tienen una larga cola hacia la derecha con valores atípicos, es decir, individuos con alta liquidez. Por otro lado, una corta cola a la izquierda da cuenta de individuos que cuentan con liquidez negativa.

En el caso de `balance` se definieron los siguientes rangos haciendo uso de los cuartiles.

* Sobregiro: `balance` < 0
* Sustancial: 0 ≤ `balance` < Q1
* Considerable: Q1 ≤ `balance` < Q3
* Elevado: `balance` ≥ Q3

Se calcularon los cuartiles `Q1` y `Q3` de la variable de `balance`

```{r}
Q1 <- quantile(df$balance, 0.25)
Q3 <- quantile(df$balance, 0.75)
```

Se creó la variable `balance_category`

```{r}
df$balance_category <- cut(
  df$balance,
  breaks = c(-Inf, 0, Q1, Q3, Inf),
  labels = c("Sobregiro", "Sustancial", "Considerable", "Elevado"),
  right = FALSE
)
```

Se generó una tabla de frecuencias con las nuevas categorías.

```{r}
association_table <- data.frame(table(df$deposit, df$balance_category))
names(association_table) <- c(target, "balance_category", "Frequency")
association_table
```

```{r cache=TRUE}
p <-
  ggplot(association_table,
         aes_string(x = "balance_category", y = "Frequency", fill = target)) +
  geom_col(position="dodge") +
  geom_text(
    aes_string(label = "Frequency"),
    size = 3,
    hjust = 0.5,
    vjust = 1,
    position = position_dodge(width = .9)
  ) +
  xlab("Balance Category")

p + theme_classic() + theme(legend.position = "bottom", legend.justification = "right")
```

> Los individuos en el rango `Considerable` resultaron ser el principal objetivo de la campaña y los datos se encuentran cercanos a estar balanceados. 

```{r}
print("Total categoría Considerable")
print(sum(association_table[association_table$balance_category == "Considerable",]$Frequency))
print("Total otras categorías")
print(
  sum(
    association_table[association_table$balance_category == "Sobregiro",]$Frequency,
    association_table[association_table$balance_category == "Sustancial",]$Frequency,
    association_table[association_table$balance_category == "Elevado",]$Frequency
  )
)
```

> Cabe destacar, el total de los individuos con baja liquidez (rangos `Sobregiro` y `Sustancial`) e individuos con mayor liquidez (rango `Elevado`) iguala al total de los individuos de liquidez `Considerable`.

#### `Campaign`

```{r}
p <-
  ggplot(df,
         aes_string(y = numeric_cols[3], x = target, fill = target)) +
  geom_boxplot(alpha = 0.5, outlier.colour="red", outlier.shape=8,
                outlier.size=2)
p1 <-
  ggplot(df,
         aes_string(x = numeric_cols[3], color = target, fill = target)) +
  geom_histogram(alpha = 0.5)

(p + guides(colour = "none" , fill = "none")) + p1 + plot_layout(ncol = 2) &
  theme_classic() + theme(legend.position = "bottom", legend.justification = "right")
```
> Lorem

```{r}
Q2 <- quantile(df$campaign, 0.50)
Q3 <- quantile(df$campaign, 0.75)
```


Se creó la variable `campaign_category`

```{r}
df$campaign_category <- cut(
  df$campaign,
  breaks = c(0, Q2, Q3, Inf),
  labels = c("Pocas", "Normal", "Elevado"),
  right = FALSE
)
```


Se generó una tabla de frecuencias con las nuevas categorías.

```{r}
association_table <- data.frame(table(df$deposit, df$campaign_category))
names(association_table) <- c(target, "campaign_category", "Frequency")
association_table
```


```{r cache=TRUE}
p <-
  ggplot(association_table,
         aes_string(x = "campaign_category", y = "Frequency", fill = target)) +
  geom_col(position="dodge") +
  geom_text(
    aes_string(label = "Frequency"),
    size = 3,
    hjust = 0.5,
    vjust = 1,
    position = position_dodge(width = .9)
  ) +
  xlab("Campaign Category")

p + theme_classic() + theme(legend.position = "bottom", legend.justification = "right")
```






```{r cache=TRUE}
p <-
  ggplot(df,
         aes_string(y = numeric_cols[3], x = target, fill = target)) + geom_jitter(width = 0.1, aes_string(color =
                                                                                                             target))
p1 <-
  ggplot(df,
         aes_string(y = numeric_cols[3], x = target, fill = target)) +
  geom_jitter(width = 0.1, aes_string(color = target))

p + guides(colour = "none" , fill = "none") + p1 + plot_layout(ncol = 2) &
  theme_classic() + theme(legend.position = "bottom", legend.justification = "right")
```


#### `Duration`

```{r cache=TRUE}
p <-
  ggplot(df_numeric, aes_string(x = target, y = numeric_cols[5])) +
  geom_jitter(width = 0.1, aes_string(color = target))
p1 <-
  ggplot(df_numeric, aes_string(x = target, y = numeric_cols[6])) +
  geom_jitter(width = 0.1, aes_string(color = target))

p + guides(colour = "none" , fill = "none") + p1 + plot_layout(ncol = 2) &
  theme_classic() + theme(legend.position = "bottom", legend.justification = "right")
```

## 4. Tabla de frecuencias \~ `marital`

Presente una tabla de frecuencias y porcentaje para la variable `marital` (estado civil) según el nivel de la variable `deposit`.

```{r}
pair <- c(target, "marital")
```

```{r}
table_freq <- table(subset(df, select = pair))
table_per <- table_freq / sum(table_freq)
```

```{r}
table_freq <- data.frame(table_freq) %>% rename("Frequency"="Freq")
table_freq
```

```{r}
table_per <- data.frame(table_per)%>% rename("Percentage"="Freq")
table_per
```

## 5. Gráfico de frecuencias \~ `marital`

Realice un gráfico para representar la tabla construida en el punto 4.

```{r cache=TRUE}
p <-
  ggplot(table_freq,
         aes_string(fill = target, y = "Frequency", x = "marital")) +
  geom_col() +
  geom_text(
    aes_string(label = "Frequency"),
    size = 3,
    hjust = 0.5,
    vjust = 3,
    position = "stack"
  )

p + theme_classic() + theme(legend.position = "bottom", legend.justification = "right")
```


```{r cache=TRUE}
p <-
  ggplot(table_per,
         aes_string(fill = target, y = "Percentage", x = "marital")) +
  geom_col() + ylim(0, 1) +
  geom_text(
    aes_string(label = "Percentage"),
    size = 3,
    hjust = 0.5,
    vjust = 1.5,
    position = "stack"
  )

p + theme_classic() + theme(legend.position = "bottom", legend.justification = "right")
```

## 6. Asociación entre `age` y `balance`

Elija dos variables `numéricas`, establezca rangos que representen distintos niveles de cada una y defina nuevas variables categóricas. Aplique un test adecuado para entender si existe asociación entre ambas. Utilice un nivel de significación del 5%.

```{r}
pair <- c("age", "duration")
```



```{r}

```

```{r}

```

7.  Seleccione la variable `education` y elija otra variable categórica. Aplique un test adecuado para entender si existe asociación entre ambas. Utilice un nivel de significación del 5%.

```{r}
pair <- c("education", "default")
```

```{r}

```

```{r}

```

8.  Seleccione otra variable continua y estime la diferencia de medias según el valor de la variable `deposit` con un nivel de confianza del 95%. Interprete el resultado obtenido.

```{r}
pair <- c("age", target)
```

```{r}

```

```{r}

```

9.  Según el resultado obtenido en el `punto 8.`- realice un test de hipótesis apropiado para determinar la diferencia de medias de la variable en estudio. Trabaje con una significación del 5%. Presente el planteo de hipótesis adecuado, la resolución y la decisión a tomar.

```{r}

```

```{r}

```

```{r}

```

10. Seleccione una muestra de `30` elementos estratificada según la variable `deposit`. ¿Se puede afirmar que hay diferencias significativas en el balance de los que realizaron el `depósito` respecto a aquellos que no lo hicieron? Elija un test de hipótesis adecuado. Trabaje con una significación del 5%.

```{r}

```

```{r}

```

```{r}

```

11. Decida si existen diferencias significativas en la `duración` respecto los niveles de `educación` (`secondary`, `tertiary`, `primary`, `unknown`). Justifique. Utilice un test adecuado. Realice las pruebas necesarias para comprobar los supuestos. Trabaje con una significación del 5%.

```{r}
pair <- c("education", "duration")
```

```{r}

```

```{r}

```

12. Elija dos variables cuantitativas, determine la variable explicativa y la variable explicada. Encuentre la ecuación de la recta de regresión lineal que explique la relación entre las variables elegidas. Escriba conclusiones acerca de la significatividad del modelo aplicado. Puede acompañar el modelo de un gráfico adecuado.

```{r}

```

```{r}

```

```{r}

```

13. Presente un informe final con un mínimo de 500 y un máximo de 800 palabras del análisis de la base de datos, describiendo la base de datos, indicando la presencia de valores atípicos y las conclusiones a las que se abordó luego del análisis.
